name: Sync YunNan Travel Plan

on:
  push:
    paths:
      - 'YunNan.md'
    branches: [ main, master ]
  pull_request:
    paths:
      - 'YunNan.md'
    branches: [ main, master ]

jobs:
  sync-to-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Sync YunNan.md to GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // è¯»å–YunNan.mdæ–‡ä»¶å†…å®¹
              const filePath = path.join(process.env.GITHUB_WORKSPACE, 'YunNan.md');
              const content = fs.readFileSync(filePath, 'utf8');
              
              const issueTitle = 'ğŸ—ºï¸ äº‘å—æ—…è¡Œè®¡åˆ’ - ååŒä»»åŠ¡æ¸…å•';
              console.log('ğŸ”„ å¼€å§‹åŒæ­¥äº‘å—æ—…è¡Œè®¡åˆ’...');
              console.log(`ğŸ“„ æ–‡ä»¶å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
              
              // æœç´¢å·²å­˜åœ¨çš„æ—…è¡Œç›¸å…³Issue
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all', // æœç´¢æ‰€æœ‰çŠ¶æ€çš„issue
                per_page: 50,
                sort: 'updated',
                direction: 'desc'
              });
              
              console.log(`ğŸ” æœç´¢åˆ° ${issues.length} ä¸ªissues`);
              
              // æŸ¥æ‰¾äº‘å—æ—…è¡Œç›¸å…³çš„Issue
              let travelIssue = null;
              for (const issue of issues) {
                if (!issue.pull_request && 
                    (issue.title.includes('äº‘å—') || 
                     issue.title.includes('æ—…è¡Œ') || 
                     issue.title.includes('å¤§ç†') || 
                     issue.title.includes('ä¸½æ±Ÿ'))) {
                  travelIssue = issue;
                  console.log(`âœ… æ‰¾åˆ°ç›¸å…³Issue: #${issue.number} - "${issue.title}"`);
                  break;
                }
              }
              
              if (travelIssue) {
                // æ£€æŸ¥Issueæ˜¯å¦å·²å…³é—­ï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°æ‰“å¼€
                if (travelIssue.state === 'closed') {
                  console.log(`ğŸ”“ é‡æ–°æ‰“å¼€å·²å…³é—­çš„Issue #${travelIssue.number}`);
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: travelIssue.number,
                    state: 'open'
                  });
                }
                
                // æ›´æ–°å·²å­˜åœ¨çš„Issue
                console.log(`ğŸ“ æ›´æ–°Issue #${travelIssue.number}...`);
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: travelIssue.number,
                  title: issueTitle,
                  body: content + `\n\n---\n*æœ€ååŒæ­¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}*` +
                        `\n*[æŸ¥çœ‹æºæ–‡ä»¶](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/YunNan.md)*`
                });
                console.log(`âœ… æˆåŠŸæ›´æ–°Issue #${travelIssue.number}`);
                
              } else {
                // åˆ›å»ºæ–°Issue
                console.log('ğŸ†• åˆ›å»ºæ–°çš„æ—…è¡Œè®¡åˆ’Issue...');
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: content + `\n\n---\n*è‡ªåŠ¨åˆ›å»ºäº: ${new Date().toLocaleString('zh-CN')}*` +
                        `\n*[æŸ¥çœ‹æºæ–‡ä»¶](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/YunNan.md)*`,
                  labels: ['travel', 'yunnan', 'checklist', 'auto-sync']
                });
                console.log(`ğŸ‰ åˆ›å»ºæ–°Issue: #${newIssue.data.number}`);
                console.log(`ğŸ”— Issueé“¾æ¥: ${newIssue.data.html_url}`);
              }
              
              console.log('âœ¨ åŒæ­¥å®Œæˆï¼');
              
            } catch (error) {
              console.error('âŒ åŒæ­¥å¤±è´¥:', error);
              
              // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
              if (error.response) {
                console.error('HTTPçŠ¶æ€ç :', error.response.status);
                console.error('é”™è¯¯ä¿¡æ¯:', error.response.data);
              }
              
              throw error;
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Success Notification
        if: success()
        run: |
          echo "âœ… YunNan.md å·²æˆåŠŸåŒæ­¥åˆ°GitHub Issue"
          echo "ğŸ“ ä¸‹æ¬¡ä¿®æ”¹YunNan.mdæ–‡ä»¶æ—¶ä¼šè‡ªåŠ¨æ›´æ–°Issue"

      - name: Send Failure Notification
        if: failure()
        run: |
          echo "âŒ YunNan.md åŒæ­¥åˆ°Issueå¤±è´¥"
          echo "ğŸ’¡ è¯·æ£€æŸ¥å·¥ä½œæµè¿è¡Œæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
