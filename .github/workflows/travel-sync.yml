name: Sync YunNan Travel Plan

on:
  push:
    paths:
      - 'YunNan.md'
    branches: [ main, master ]

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  issues: write

jobs:
  sync-to-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find or Create Travel Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // è¯»å–YunNan.mdæ–‡ä»¶å†…å®¹
              const filePath = path.join(process.env.GITHUB_WORKSPACE, 'YunNan.md');
              const content = fs.readFileSync(filePath, 'utf8');
              
              const issueTitle = 'ğŸ—ºï¸ äº‘å—æ—…è¡Œè®¡åˆ’ - ååŒä»»åŠ¡æ¸…å•';
              console.log('ğŸ”„ å¼€å§‹åŒæ­¥äº‘å—æ—…è¡Œè®¡åˆ’...');
              
              // é¦–å…ˆå°è¯•æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå·²çŸ¥ç¼–å·çš„Issueï¼ˆæ¯”å¦‚ #2ï¼‰
              const TARGET_ISSUE_NUMBER = 2;
              
              console.log(`ğŸ“ å°è¯•æ›´æ–°Issue #${TARGET_ISSUE_NUMBER}...`);
              
              try {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: TARGET_ISSUE_NUMBER,
                  body: content + `\n\n---\n*æœ€ååŒæ­¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}*` +
                        `\n*[æŸ¥çœ‹æºæ–‡ä»¶](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/YunNan.md)*`
                });
                console.log(`âœ… æˆåŠŸæ›´æ–°Issue #${TARGET_ISSUE_NUMBER}`);
                return;
                
              } catch (updateError) {
                if (updateError.status === 404 || updateError.status === 410) {
                  console.log(`âŒ Issue #${TARGET_ISSUE_NUMBER} ä¸å­˜åœ¨ï¼Œå°è¯•æœç´¢ç°æœ‰Issue...`);
                  
                  // æœç´¢ç°æœ‰Issue
                  const { data: issues } = await github.rest.issues.listForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'all',
                    per_page: 30
                  });
                  
                  // æŸ¥æ‰¾æ—…è¡Œç›¸å…³Issue
                  const travelIssue = issues.find(issue => 
                    !issue.pull_request && 
                    (issue.title.includes('äº‘å—') || issue.title.includes('æ—…è¡Œ') || 
                     issue.title.includes('å¤§ç†') || issue.title.includes('ä¸½æ±Ÿ'))
                  );
                  
                  if (travelIssue) {
                    console.log(`âœ… æ‰¾åˆ°ç›¸å…³Issue: #${travelIssue.number}`);
                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: travelIssue.number,
                      body: content + `\n\n---\n*æœ€ååŒæ­¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}*`
                    });
                    console.log(`âœ… æˆåŠŸæ›´æ–°Issue #${travelIssue.number}`);
                  } else {
                    console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ç°æœ‰Issueï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º');
                    console.log('ğŸ’¡ è¯·æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªIssueï¼Œç„¶åæ›´æ–°å·¥ä½œæµä¸­çš„TARGET_ISSUE_NUMBER');
                  }
                } else {
                  throw updateError;
                }
              }
              
            } catch (error) {
              console.error('âŒ åŒæ­¥å¤±è´¥:', error.message);
              console.log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ:');
              console.log('1. æ‰‹åŠ¨åœ¨GitHubä»“åº“ä¸­åˆ›å»ºä¸€ä¸ªIssue');
              console.log('2. è®°ä¸‹Issueç¼–å·');
              console.log('3. æ›´æ–°å·¥ä½œæµä¸­çš„ TARGET_ISSUE_NUMBER å˜é‡');
              throw error;
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}
